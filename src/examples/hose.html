<html>
<head><script>
    class Prms {
        constructor(resolverCallback) {
            const resolve = (res) => {
                if (typeof this.cb === 'function') {
                    this.cb.call(this.cb, res);
                }
            }

            resolverCallback.call(resolverCallback, resolve);
        }

        then(cb) {
            this.cb = cb;
        }
    }
    class Hose {
        constructor(v) {
            this.initValue = v;
            this._init = true;
            this.cal = null;
        }

        pipe(operation) {
            let resolver = null;
            const p = new Prms((resolve) => {
                resolver = resolve;
            });

            if (true === this._init) {
                this.cal = () => {
                    operation.call(this, this.initValue, resolver);

                    return p;
                };
                this._init = false;
            } else {
                const _cal = this.cal;
                this.cal = () => {
                    _cal.call(this).then((res) => {
                        operation.call(this, res, resolver);
                    });

                    return p;
                };
            }

            return this;
        }

        yield(cb) {
            this.cal().then((res) => {
                cb.call(cb, res);
            });
        }
    }
</script></head>
<script>
    (new Hose(10))
        .pipe((res, resolve) => {
            resolve(res + 1);
        })
        .pipe((res, resolve) => {
            resolve(res - 2)
        })
        .yield((res) => {
            console.log(res, 9)
        });


    (new Hose(100)).pipe((res, resolve) => {
        setTimeout(() => {
            resolve(res + 10);
        }, 100);
    })
        .pipe((res, resolve) => {
            setTimeout(() => {
                resolve(res - 20);
            }, 200);
        })
        .yield((res) => {
            console.log(res, 90)
        });

    (new Hose(1)).pipe((res, resolve) => {
        setTimeout(() => {
            resolve(res + 10);
        }, 1);
    })
        .pipe((res, resolve) => {
            // setTimeout(() => {
            resolve(res - 20);
            // }, 20);
        })
        .yield((res) => {
            console.log(res, -9)
        });
</script>
</html>